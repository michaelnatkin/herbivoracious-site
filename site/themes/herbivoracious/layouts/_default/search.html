{{ define "main" }}
<div class="site-content">
  <main class="main-content">
    <div class="search-page">
      <h1>Search</h1>
      <form class="search-form" id="search-form" action="/search/" method="get">
        <input type="text" id="search-input" name="q" placeholder="Search recipes, ingredients, techniques&hellip;" aria-label="Search" autofocus>
        <button type="submit">Search</button>
      </form>
      <div id="search-status" class="search-status"></div>
      <div id="search-results"></div>
    </div>
  </main>

  {{ partial "sidebar.html" . }}
</div>

<script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>
<script>
(function() {
  let searchIndex = null;
  let fuse = null;

  const input = document.getElementById('search-input');
  const results = document.getElementById('search-results');
  const status = document.getElementById('search-status');
  const form = document.getElementById('search-form');

  // Load search index
  fetch('/index.json')
    .then(r => r.json())
    .then(data => {
      searchIndex = data;
      fuse = new Fuse(data, {
        keys: [
          { name: 'title', weight: 0.5 },
          { name: 'categories', weight: 0.3 },
          { name: 'summary', weight: 0.2 }
        ],
        threshold: 0.4,
        includeScore: true,
        minMatchCharLength: 2
      });

      // Check for query parameter on load
      const params = new URLSearchParams(window.location.search);
      const q = params.get('q');
      if (q) {
        input.value = q;
        doSearch(q);
      }
    });

  form.addEventListener('submit', function(e) {
    e.preventDefault();
    const q = input.value.trim();
    if (q) {
      history.replaceState(null, '', '/search/?q=' + encodeURIComponent(q));
      doSearch(q);
    }
  });

  // Live search as you type
  let debounce;
  input.addEventListener('input', function() {
    clearTimeout(debounce);
    debounce = setTimeout(function() {
      const q = input.value.trim();
      if (q.length >= 2) {
        history.replaceState(null, '', '/search/?q=' + encodeURIComponent(q));
        doSearch(q);
      } else {
        results.innerHTML = '';
        status.textContent = '';
      }
    }, 250);
  });

  function doSearch(query) {
    if (!fuse) {
      status.textContent = 'Loading search index\u2026';
      return;
    }

    const matches = fuse.search(query, { limit: 30 });

    if (matches.length === 0) {
      status.textContent = 'No results found for \u201c' + escapeHtml(query) + '\u201d';
      results.innerHTML = '';
      return;
    }

    status.textContent = matches.length + ' result' + (matches.length === 1 ? '' : 's') + ' for \u201c' + escapeHtml(query) + '\u201d';

    let html = '';
    matches.forEach(function(match) {
      const item = match.item;
      const imgHtml = item.cover
        ? '<img class="search-result__image" src="' + escapeHtml(item.cover) + '" alt="" loading="lazy">'
        : '';
      const cats = item.categories && item.categories.length
        ? item.categories.slice(0, 2).join(' \u00b7 ')
        : '';
      html += '<div class="search-result">'
        + imgHtml
        + '<div class="search-result__body">'
        + '<div class="search-result__title"><a href="' + escapeHtml(item.permalink) + '">' + escapeHtml(item.title) + '</a></div>'
        + '<div class="search-result__meta">' + escapeHtml(item.date) + (cats ? ' \u00b7 ' + escapeHtml(cats) : '') + '</div>'
        + '<div class="search-result__excerpt">' + escapeHtml(item.summary) + '</div>'
        + '</div></div>';
    });
    results.innerHTML = html;
  }

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }
})();
</script>
{{ end }}
